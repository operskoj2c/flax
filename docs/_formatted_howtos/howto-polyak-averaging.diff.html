<div class="highlight-default notranslate"><div class="highlight">
<pre class="code">
<span style="background-color: rgba(255, 0, 0, 0.3)"><span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">mnist</span><span class="o">/</span><span class="n">train</span><span class="o">.</span><span class="n">py</span></span>
<span style="background-color: rgba(0, 255, 0, 0.3)"><span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">mnist</span><span class="o">/</span><span class="n">train</span><span class="o">.</span><span class="n">py</span></span>
<span style="background-color: rgba(128, 128, 128, 0.3)">[...]</span>
 
 <span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span style="background-color: rgba(255, 0, 0, 0.3)"><span class="o">-</span><span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span></span>
<span style="background-color: rgba(0, 255, 0, 0.3)"><span class="o">+</span><span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">params_ema</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span></span>
   <span class="sd">&quot;&quot;&quot;Train for a single step.&quot;&quot;&quot;</span>
   <span class="k">def</span> <span class="nf">loss_fn</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
     <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">])</span>
<span style="background-color: rgba(128, 128, 128, 0.3)">[...]</span>
   <span class="n">grad_fn</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">,</span> <span class="n">has_aux</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
   <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">logits</span><span class="p">),</span> <span class="n">grad</span> <span class="o">=</span> <span class="n">grad_fn</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
   <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">apply_gradient</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
<span style="background-color: rgba(0, 255, 0, 0.3)"><span class="o">+</span>  <span class="n">params_ema</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_multimap</span><span class="p">(</span></span>
<span style="background-color: rgba(0, 255, 0, 0.3)"><span class="o">+</span>      <span class="k">lambda</span> <span class="n">p_ema</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="n">p_ema</span> <span class="o">*</span> <span class="mf">0.99</span> <span class="o">+</span> <span class="n">p</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">,</span></span>
<span style="background-color: rgba(0, 255, 0, 0.3)"><span class="o">+</span>      <span class="n">params_ema</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">params</span><span class="p">)</span></span>
   <span class="n">metrics</span> <span class="o">=</span> <span class="n">compute_metrics</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>
<span style="background-color: rgba(255, 0, 0, 0.3)"><span class="o">-</span>  <span class="k">return</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">metrics</span></span>
<span style="background-color: rgba(0, 255, 0, 0.3)"><span class="o">+</span>  <span class="k">return</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">params_ema</span><span class="p">,</span> <span class="n">metrics</span></span>
 
 <span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span style="background-color: rgba(128, 128, 128, 0.3)">[...]</span>
   <span class="k">return</span> <span class="n">compute_metrics</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>
 
<span style="background-color: rgba(255, 0, 0, 0.3)"><span class="o">-</span><span class="k">def</span> <span class="nf">train_epoch</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">train_ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">rng</span><span class="p">):</span></span>
<span style="background-color: rgba(0, 255, 0, 0.3)"><span class="o">+</span><span class="k">def</span> <span class="nf">train_epoch</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">params_ema</span><span class="p">,</span> <span class="n">train_ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">rng</span><span class="p">):</span></span>
   <span class="sd">&quot;&quot;&quot;Train for a single epoch.&quot;&quot;&quot;</span>
   <span class="n">train_ds_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_ds</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">])</span>
   <span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="n">train_ds_size</span> <span class="o">//</span> <span class="n">batch_size</span>
<span style="background-color: rgba(128, 128, 128, 0.3)">[...]</span>
   <span class="n">batch_metrics</span> <span class="o">=</span> <span class="p">[]</span>
   <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">perms</span><span class="p">:</span>
     <span class="n">batch</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">perm</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span style="background-color: rgba(255, 0, 0, 0.3)"><span class="o">-</span>    <span class="n">optimizer</span><span class="p">,</span> <span class="n">metrics</span> <span class="o">=</span> <span class="n">train_step</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span></span>
<span style="background-color: rgba(0, 255, 0, 0.3)"><span class="o">+</span>    <span class="n">optimizer</span><span class="p">,</span> <span class="n">params_ema</span><span class="p">,</span> <span class="n">metrics</span> <span class="o">=</span> <span class="n">train_step</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">params_ema</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span></span>
     <span class="n">batch_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
 
   <span class="c1"># compute mean of metrics across each batch in epoch.</span>
<span style="background-color: rgba(128, 128, 128, 0.3)">[...]</span>
 
   <span class="n">model</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span>
   <span class="n">optimizer</span> <span class="o">=</span> <span class="n">create_optimizer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">momentum</span><span class="p">)</span>
<span style="background-color: rgba(0, 255, 0, 0.3)"><span class="o">+</span>  <span class="n">params_ema</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span></span>
 
   <span class="n">input_rng</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
 
   <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
     <span class="n">optimizer</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">train_epoch</span><span class="p">(</span>
<span style="background-color: rgba(255, 0, 0, 0.3)"><span class="o">-</span>        <span class="n">optimizer</span><span class="p">,</span> <span class="n">train_ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">input_rng</span><span class="p">)</span></span>
<span style="background-color: rgba(0, 255, 0, 0.3)"><span class="o">+</span>        <span class="n">optimizer</span><span class="p">,</span> <span class="n">params_ema</span><span class="p">,</span> <span class="n">train_ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">input_rng</span><span class="p">)</span></span>
     <span class="n">loss</span><span class="p">,</span> <span class="n">accuracy</span> <span class="o">=</span> <span class="n">eval_model</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">test_ds</span><span class="p">)</span>
     <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;eval epoch: </span><span class="si">%d</span><span class="s1">, loss: </span><span class="si">%.4f</span><span class="s1">, accuracy: </span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="n">epoch</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">accuracy</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
<span style="background-color: rgba(0, 255, 0, 0.3)"><span class="o">+</span>    <span class="n">model_ema</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params_ema</span><span class="p">)</span></span>
<span style="background-color: rgba(0, 255, 0, 0.3)"><span class="o">+</span>    <span class="n">polyak_loss</span><span class="p">,</span> <span class="n">polyak_accuracy</span> <span class="o">=</span> <span class="n">eval_model</span><span class="p">(</span><span class="n">model_ema</span><span class="p">,</span> <span class="n">test_ds</span><span class="p">)</span></span>
<span style="background-color: rgba(0, 255, 0, 0.3)"><span class="o">+</span>    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;polyak eval epoch: </span><span class="si">%d</span><span class="s1">, loss: </span><span class="si">%.4f</span><span class="s1">, accuracy: </span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="p">,</span></span>
<span style="background-color: rgba(0, 255, 0, 0.3)"><span class="o">+</span>                 <span class="n">epoch</span><span class="p">,</span> <span class="n">polyak_loss</span><span class="p">,</span> <span class="n">polyak_accuracy</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span></span>
   <span class="k">return</span> <span class="n">optimizer</span>
 
</pre></div></div>
